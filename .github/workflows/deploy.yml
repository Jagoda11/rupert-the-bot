name: Deploy Probot App to AWS Lambda

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code üì•
        uses: actions/checkout@v2

      - name: Set up Node.js üõ†Ô∏è
        uses: actions/setup-node@v2
        with:
          node-version: '21'

      - name: Install dependencies üì¶üöÄ
        run: npm install

      - name: Package application using AWS SAM üì¶
        run: sam build --use-container

      - name: Mask AWS account ID üé≠üé≠
        run: echo "::add-mask::$(aws sts get-caller-identity --query Account --output text)"
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'eu-north-1'

      - name: Mask S3 bucket name üé≠
        run: echo "::add-mask::${{ secrets.S3_BUCKET_NAME }}"

      - name: Mask ROLE_ARN üé≠
        run: echo "::add-mask::${{ secrets.ROLE_ARN }}"

      - name: Mask WEBHOOK_SECRET üé≠
        run: echo "::add-mask::${{ secrets.WEBHOOK_SECRET }}"

      - name: Mask APP_ID üé≠
        run: echo "::add-mask::${{ secrets.APP_ID }}"
        env:
          APP_ID: ${{ secrets.APP_ID }}

      - name: Mask PRIVATE_KEY üé≠
        run: echo "::add-mask::${{ secrets.PRIVATE_KEY }}"
        env:
          PRIVATE_KEY: ${{ secrets.PRIVATE_KEY }}

      - name: Mask PROBOT_GITHUB_TOKEN üé≠
        run: echo "::add-mask::${{ secrets.PROBOT_GITHUB_TOKEN }}"
        env:
          PROBOT_GITHUB_TOKEN: ${{ secrets.PROBOT_GITHUB_TOKEN }}

      - name: Deploy to AWS Lambda üöÄ
        run: sam deploy --no-fail-on-empty-changeset --stack-name rupert-stack-2 --capabilities CAPABILITY_IAM --role-arn ${{ secrets.ROLE_ARN }} --region eu-north-1 --s3-bucket ${{ secrets.S3_BUCKET_NAME }} --parameter-overrides 'SAMDeploymentRole=${{ secrets.ROLE_ARN }} WebhookSecret=${{ secrets.WEBHOOK_SECRET }} AppId=${{ secrets.APP_ID }} GitHubToken=${{ secrets.PROBOT_GITHUB_TOKEN }}'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'eu-north-1'
          APP_ID: ${{ secrets.APP_ID }}
          PROBOT_GITHUB_TOKEN: ${{ secrets.PROBOT_GITHUB_TOKEN }}

      - name: Update PrivateKey environment variable
        run: aws lambda update-function-configuration --function-name rupert-stack-2-ProbotFunction-xTxVStVIYCcR --environment 'Variables={PRIVATE_KEY=${{ secrets.PRIVATE_KEY }}, PROBOT_GITHUB_TOKEN=${{ secrets.PROBOT_GITHUB_TOKEN }}}'
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: 'eu-north-1'
